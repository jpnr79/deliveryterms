name: REPO_WRITE_TOKEN manual dispatch test

on:
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'Pull request number to update'
        required: true
        type: number

permissions:
  contents: write

jobs:
  manual-test:
    runs-on: ubuntu-latest

    steps:
      - name: Ensure REPO_WRITE_TOKEN exists
        run: |
          if [ -z "${{ secrets.REPO_WRITE_TOKEN }}" ]; then
            echo "REPO_WRITE_TOKEN is not set. Aborting." >&2
            exit 1
          fi

      - name: Manual REPO_WRITE_TOKEN PR update
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.REPO_WRITE_TOKEN }}
          script: |
            const prNumber = parseInt((context.payload.inputs && context.payload.inputs.pr_number), 10) || null;
            if (!prNumber) throw new Error('pr_number input is required');
            const markerStart = '<!-- repo-write-token-manual:start -->';
            const markerEnd = '<!-- repo-write-token-manual:end -->';
            const now = new Date().toISOString();
            const summary = `**MANUAL SMOKE**: Updated via \`REPO_WRITE_TOKEN\` at ${now}.`;

            const { data: pr } = await github.rest.pulls.get({ owner: context.repo.owner, repo: context.repo.repo, pull_number: prNumber });
            const body = pr.body || '';
            const startIdx = body.indexOf(markerStart);
            let newBody;
            if (startIdx !== -1) {
              const endIdx = body.indexOf(markerEnd, startIdx);
              if (endIdx !== -1) {
                newBody = body.slice(0, startIdx) + markerStart + '\n' + summary + '\n' + markerEnd + body.slice(endIdx + markerEnd.length);
              } else {
                newBody = body.slice(0, startIdx) + markerStart + '\n' + summary + '\n' + markerEnd;
              }
            } else {
              newBody = markerStart + '\n' + summary + '\n' + markerEnd + '\n\n' + body;
            }

            await github.rest.pulls.update({ owner: context.repo.owner, repo: context.repo.repo, pull_number: prNumber, body: newBody });
            await github.rest.issues.createComment({ owner: context.repo.owner, repo: context.repo.repo, issue_number: prNumber, body: `Manual REPO_WRITE_TOKEN test: I updated the PR body (opt-in manual run).` });

      - name: Done
        run: echo "Manual REPO_WRITE_TOKEN run complete"